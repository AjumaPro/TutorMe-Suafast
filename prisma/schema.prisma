// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Enums converted to strings for SQLite compatibility
// UserRole: PARENT, TUTOR, ADMIN
// LessonType: IN_PERSON, ONLINE
// BookingStatus: PENDING, CONFIRMED, COMPLETED, CANCELLED
// PaymentStatus: PENDING, PAID, REFUNDED, FAILED

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          String    @default("PARENT") // PARENT, TUTOR, ADMIN
  phone         String?
  image         String?
  emailVerified DateTime?
  resetToken    String?   // Password reset token
  resetTokenExpiry DateTime? // Token expiration
  failedLoginAttempts Int @default(0) // Track failed login attempts
  accountLockedUntil DateTime? // Account lockout until this time
  lastLoginAt   DateTime? // Track last successful login
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  tutorProfile  TutorProfile?
  bookings      Booking[]  @relation("StudentBookings")
  reviews       Review[]
  addresses     Address[]
  sentMessages      Message[]  @relation("SentMessages")
  receivedMessages   Message[]  @relation("ReceivedMessages")
  notifications Notification[]
  assignments   Assignment[]
  progressEntries ProgressEntry[]

  @@map("users")
}

model TutorProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  bio             String?
  subjects        String   @default("[]") // JSON array: ["Math", "Science", "English"]
  grades          String   @default("[]") // JSON array: ["K-5", "6-8", "9-12"]
  experience      Int?     // years of experience
  hourlyRate      Float
  isVerified      Boolean  @default(false)
  isApproved      Boolean  @default(false) // Admin approval
  credentials     String?  // URL to uploaded credentials
  availability    String?  // JSON string: Store availability schedule
  rating          Float    @default(0)
  totalReviews    Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings        Booking[]
  reviews         Review[]
  availabilitySlots AvailabilitySlot[]
  videoSessions   VideoSession[]

  @@map("tutor_profiles")
}

model Address {
  id          String   @id @default(cuid())
  userId      String
  street      String
  city        String
  state       String
  zipCode     String
  country     String   @default("USA")
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings    Booking[]

  @@map("addresses")
}

model AvailabilitySlot {
  id          String   @id @default(cuid())
  tutorId     String
  dayOfWeek   Int      // 0 = Sunday, 1 = Monday, etc.
  startTime   String   // "09:00"
  endTime     String   // "17:00"
  isAvailable Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tutor       TutorProfile @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@map("availability_slots")
}

model Booking {
  id            String        @id @default(cuid())
  studentId     String
  tutorId       String
  lessonType    String    // IN_PERSON, ONLINE
  subject       String
  scheduledAt   DateTime
  duration      Int           // minutes
  price         Float
  status        String        @default("PENDING") // PENDING, CONFIRMED, COMPLETED, CANCELLED
  addressId     String?       // For in-person lessons
  meetingUrl    String?       // For online lessons
  notes         String?
  isRecurring   Boolean       @default(false)
  recurringPattern String?   // WEEKLY, MONTHLY, BIWEEKLY
  recurringEndDate DateTime? // When recurring bookings should stop
  parentBookingId String?     // For recurring bookings, links to parent
  isGroupClass  Boolean       @default(false) // Whether this is a group class
  groupClassId String?        // ID of the parent group class (if null, this is the parent or not a group class)
  maxParticipants Int         @default(10) // Maximum participants for group classes
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  student       User          @relation("StudentBookings", fields: [studentId], references: [id])
  tutor         TutorProfile  @relation(fields: [tutorId], references: [id])
  address       Address?      @relation(fields: [addressId], references: [id])
  payment       Payment?
  review        Review?
  videoSession  VideoSession?
  messages      Message[]
  assignments   Assignment[]
  childBookings Booking[]     @relation("RecurringBookings")
  parentBooking Booking?     @relation("RecurringBookings", fields: [parentBookingId], references: [id])

  @@map("bookings")
}

model Payment {
  id            String        @id @default(cuid())
  bookingId     String        @unique
  amount        Float
  platformFee   Float         // Commission (e.g., 15%)
  tutorPayout   Float         // Amount tutor receives
  paystackPaymentId String?     @unique
  paystackReference String?   @unique
  status        String        @default("PENDING") // PENDING, PAID, REFUNDED, FAILED
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  booking       Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Review {
  id          String   @id @default(cuid())
  bookingId   String   @unique
  studentId   String
  tutorId     String
  rating      Int      // 1-5
  comment     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  student     User     @relation(fields: [studentId], references: [id])
  tutor       TutorProfile @relation(fields: [tutorId], references: [id])

  @@map("reviews")
}

model VideoSession {
  id            String   @id @default(cuid())
  bookingId     String?  @unique // Optional for ad-hoc sessions
  sessionToken  String   @unique
  status        String   @default("ACTIVE") // ACTIVE, ENDED
  startedAt     DateTime @default(now())
  endedAt       DateTime?
  tutorId       String?  // For ad-hoc sessions
  subject       String?  // Optional subject/topic for ad-hoc sessions
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  booking       Booking?  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  tutor         TutorProfile? @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  @@map("video_sessions")
}

model Message {
  id          String   @id @default(cuid())
  senderId    String
  recipientId String
  content     String
  bookingId   String?  // Optional link to booking
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  sender      User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  recipient   User     @relation("ReceivedMessages", fields: [recipientId], references: [id], onDelete: Cascade)
  booking     Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@map("messages")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // BOOKING_CREATED, PAYMENT_RECEIVED, REVIEW_RECEIVED, MESSAGE_RECEIVED, LESSON_REMINDER, etc.
  title     String
  message   String
  isRead    Boolean  @default(false)
  link      String?  // Optional link to related page
  metadata  String?  // JSON string for additional data
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Assignment {
  id          String   @id @default(cuid())
  bookingId   String
  studentId   String
  tutorId     String
  title       String
  description String?
  fileUrl     String?  // URL to uploaded file
  fileName    String?
  fileSize    Int?     // in bytes
  status      String   @default("SUBMITTED") // SUBMITTED, REVIEWED, COMPLETED
  feedback    String?
  grade       String?  // Optional grade/score
  submittedAt DateTime @default(now())
  reviewedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  student     User     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("assignments")
}

model ProgressEntry {
  id          String   @id @default(cuid())
  studentId   String
  tutorId     String?
  bookingId   String?  // Optional link to specific lesson
  subject     String
  topic       String?  // Specific topic covered
  score       Float?   // Performance score (0-100)
  notes       String?  // Tutor notes on progress
  milestone   String?  // Achievement milestone
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  student     User     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("progress_entries")
}

